(()=>{var u=class{static export(t,e){Object.defineProperty(typeof global<"u"?global:window,t,{value:e})}static body(){return document.body}static render(t){let e=document.createRange().createContextualFragment(t).firstChild;return e.parentNode.removeChild(e),e}static parent(t){return t.parentNode}static find(t,e){return t.querySelector(e)}static attr(t,e){for(let n in e)t.setAttribute(n,e[n])}static css(t,e){let n=t.style;for(let o in e)n[o]=e[o]}static toggleClass(t,e,n){t.classList.toggle(e,n)}static hasClass(t,e){return t.classList.contains(e)}static data(t,e,n){if(typeof n>"u")return t.dataset[e];t.dataset[e]=n}static text(t,e){t.textContent=e}static value(t,e){if(typeof e>"u")return t.value;t.value=e}static disabled(t,e){t.disabled=e}static checked(t){return t.checked}static focus(t){t.focus()}static blur(t){t.blur()}static file(t){return t.files[0]}static contentWindow(t){return t.contentWindow}static contentHeight(t){return t.contentDocument.documentElement.scrollHeight}static translateY(t,e){t.style.transform=`translateY(${e}px)`}static on(t,...e){t.addEventListener(...e)}static off(t,...e){t.removeEventListener(...e)}static once(t,e,n,o){t.addEventListener(e,n,{capture:typeof o<"u"?o:!1,once:!0})}static click(t){t.click()}static target(t){return t.target}static key(t){return t.key}static cancel(t){t.preventDefault()}static readFile(t){return new Promise((e,n)=>{let o=new FileReader,c=()=>{n(new Error(`Failed to read file: ${t.name}`))};o.onload=d=>{e(d.target.result)},o.onerror=c,o.onabort=c,o.readAsText(t)})}static fileName(t){return t.name}static location(){return document.location}static urlQuery(t,e){return new URLSearchParams(t.search).get(e)}static load(t,e){return JSON.parse(localStorage.getItem(t))||e}static save(t,e){localStorage.setItem(t,JSON.stringify(e))}};var X=Object.getOwnPropertyNames,$=(f,t)=>function(){return t||(0,f[X(f)[0]])((t={exports:{}}).exports,t),t.exports},U=$({"node_modules/circuit/circuit.js"(f,t){(function(e){"use strict";var n=function(r,i){for(var l=r.length-1;l>=0;l--)if(r[l]===i)return l;return-1},o=function(r,i){for(var l=r.length,a=Array(l),h=0;h<l;h++)a[h]=i(r[h],h,r);return a},c=function(r){return r},d={},m=function(r){var i=this,l=function(){if(typeof arguments[0]>"u")return i.update(),i.cache;var a=i.value.apply(null,arguments);a!==i.cache&&(i.updateCache(a),i.markDirty())};return l._self=i,this.func=l,this.targets=[],this.sources=[],typeof r!="function"?(this.cache=r,this.value=c,this.dirty=!1,this.timer=null):(this.value=r,this.dirty=!0,this.timer=setTimeout(function(){i.timer=null,i.dirty=!0,i.update()},0)),l};m.prototype.update=function(){if(this.dirty){this.dirty=!1;var r=o(this.sources,function(l){return l()}),i=this.value.apply(null,r);i!==this.cache&&(this.updateCache(i),this.markDirty())}},m.prototype.updateCache=function(r){this.cache=r,this.dirty=!1},m.prototype.markDirty=function(){if(m.markDirtyTargets(this.targets),!!this.dirty&&(this.dirty=!1,this.timer===null)){var r=this;this.timer=setTimeout(function(){r.timer=null,r.dirty=!0,r.update()},0)}},m.markDirtyTargets=function(){var r=[],i=null;return function(l){for(var a=0,h=l.length;a<h;a++){var p=l[a],_=p._self;_.dirty||(_.dirty=!0,n(r,p)===-1&&r.push(p),m.markDirtyTargets(_.targets))}i===null&&(i=setTimeout(function v(){var x=r.slice();r=[];for(var y=0,E=x.length;y<E;y++){var Y=x[y];Y._self.dirty&&Y()}r.length!==0&&v(),i=null},0))}}();var s=function(r){var i=this,l=function(a){var h=!1;typeof a>"u"&&(a=null);var p=function(v){if(typeof v>"u")return a;a=v},_={cancel:function(){h=!0},dispatch:function(){i.dispatch(p())},context:p};typeof r=="function"&&r(_),!h&&i.dispatch(p())};return l._self=i,this.func=l,this.targets=[],this.sources=[],l};s.prototype.dispatch=function(r){var i=this.targets;setTimeout(function(){for(var l=0,a=i.length;l<a;l++)i[l](r)},0)},d.data=function(r){return new m(r)},d.prop=d.data,d.event=function(r){return new s(r)},d.bind=function(r,i){if(!r||!i)throw new TypeError("Not enough arguments");var l=r._self,a=i._self;if(l.constructor!==a.constructor)throw new TypeError("Cannot bind data and event");l.targets.push(i),a.sources.push(r),l.constructor===m&&(m.markDirtyTargets([i]),r())},d.unbind=function(r,i){if(!r||!i)throw new TypeError("Not enough arguments");var l=r._self,a=i._self,h=n(l.targets,i);if(h===-1)throw new Error("Already unbound");a.constructor===m&&a.dirty&&i();var p=n(a.sources,r);a.sources.splice(p,1),l.targets.splice(h,1)},typeof t<"u"&&t.exports?t.exports=d:e.circuit=d})(f)}}),T=U();var b=class{static remove(t,e){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}static wrapper=()=>class I{constructor(e,n){return Object.defineProperty(n,"unwrap",{value:I._unwrap.bind(e)})}static _unwrap(e){return e===I.KEY?this:null}static KEY=Symbol()}};var S=b.wrapper(),w=class f{constructor(t,e){this._memberTable=t,this._options=e}get(t){return this._memberTable[t]||null}serialize(){return typeof this._options.serialize=="function"?this._options.serialize():null}deserialize(t){t!=null&&typeof this._options.deserialize=="function"&&this._options.deserialize(t)}static bind(t,e){let n=t.unwrap(S.KEY).callee,o=e.unwrap(S.KEY).callee;T.bind(n,o)}static unbind(t,e){let n=t.unwrap(S.KEY).callee,o=e.unwrap(S.KEY).callee;T.unbind(n,o)}static PlayBuildModule=class{constructor(t,e){return new f(t.reduce((n,o)=>(n[o.name]=new A(o),n),{}),e||{})}}},A=class{constructor(t){return this.callee=T[t.type](t.arg),this._wrapper(t.name)}_call(...t){return this.callee.apply(this,t)}_wrapper(t){let e=new S(this,this._call.bind(this));return Object.defineProperty(e,"name",{value:t})}};var z=Object.getOwnPropertyNames,H=(f,t)=>function(){return t||(0,f[z(f)[0]])((t={exports:{}}).exports,t),t.exports},q=H({"node_modules/file-saver/dist/FileSaver.min.js"(f,t){(function(e,n){typeof define=="function"&&define.amd?define([],n):typeof f<"u"?n():(n(),e.FileSaver={})})(f,function(){"use strict";function e(r,i){return typeof i>"u"?i={autoBom:!1}:typeof i!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),i={autoBom:!i}),i.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(r.type)?new Blob(["\uFEFF",r],{type:r.type}):r}function n(r,i,l){var a=new XMLHttpRequest;a.open("GET",r),a.responseType="blob",a.onload=function(){s(a.response,i,l)},a.onerror=function(){console.error("could not download file")},a.send()}function o(r){var i=new XMLHttpRequest;i.open("HEAD",r,!1);try{i.send()}catch{}return 200<=i.status&&299>=i.status}function c(r){try{r.dispatchEvent(new MouseEvent("click"))}catch{var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),r.dispatchEvent(i)}}var d=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof global=="object"&&global.global===global?global:void 0,m=d.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),s=d.saveAs||(typeof window!="object"||window!==d?function(){}:"download"in HTMLAnchorElement.prototype&&!m?function(r,i,l){var a=d.URL||d.webkitURL,h=document.createElement("a");i=i||r.name||"download",h.download=i,h.rel="noopener",typeof r=="string"?(h.href=r,h.origin===location.origin?c(h):o(h.href)?n(r,i,l):c(h,h.target="_blank")):(h.href=a.createObjectURL(r),setTimeout(function(){a.revokeObjectURL(h.href)},4e4),setTimeout(function(){c(h)},0))}:"msSaveOrOpenBlob"in navigator?function(r,i,l){if(i=i||r.name||"download",typeof r!="string")navigator.msSaveOrOpenBlob(e(r,l),i);else if(o(r))n(r,i,l);else{var a=document.createElement("a");a.href=r,a.target="_blank",setTimeout(function(){c(a)})}}:function(r,i,l,a){if(a=a||open("","_blank"),a&&(a.document.title=a.document.body.innerText="downloading..."),typeof r=="string")return n(r,i,l);var h=r.type==="application/octet-stream",p=/constructor/i.test(d.HTMLElement)||d.safari,_=/CriOS\/[\d]+/.test(navigator.userAgent);if((_||h&&p||m)&&typeof FileReader<"u"){var v=new FileReader;v.onloadend=function(){var E=v.result;E=_?E:E.replace(/^data:[^;]*;/,"data:attachment/file;"),a?a.location.href=E:location=E,a=null},v.readAsDataURL(r)}else{var x=d.URL||d.webkitURL,y=x.createObjectURL(r);a?a.location=y:location.href=y,a=null,setTimeout(function(){x.revokeObjectURL(y)},4e4)}});d.saveAs=s.saveAs=s,typeof t<"u"&&(t.exports=s)})}}),R=q();var W=Object.getOwnPropertyNames,K=(f,t)=>function(){return t||(0,f[W(f)[0]])((t={exports:{}}).exports,t),t.exports},G=K({"node_modules/jcore/jcore.js"(f,t){(function(){"use strict";window.requestAnimationFrame||(window.requestAnimationFrame=function(s){return setTimeout(s,1e3/60)});var e=function(s,r){s.prototype=Object.create(r.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}})},n={};n.Draggable=function(){var s=function(r){this.el=r,this.onstart=null,this.onmove=null,this.onend=null,this.onmousedown=this.onmousedown.bind(this),this.onmousemove=this.onmousemove.bind(this),this.onmouseup=this.onmouseup.bind(this),this.ontouchstart=this.ontouchstart.bind(this),this.ontouchmove=this.ontouchmove.bind(this),this.ontouchend=this.ontouchend.bind(this),this.pointers={}};return s.IDENTIFIER_MOUSE=0,s.Pointer=function(r,i,l,a,h){this.identifier=r,this.startPageX=i,this.startPageY=l,this.startScrollX=a.x,this.startScrollY=a.y,this.startScrollWidth=a.width,this.startScrollHeight=a.height,this.dScrollX=0,this.dScrollY=0,this.context={},this.onscroll=h},s.debounce=function(r,i){var l=0,a=null,h=null;return function(){a=this,h=arguments,l&&clearTimeout(l),l=setTimeout(function(){r.apply(a,h),l=0,a=null,h=null},i)}},s.supportsTouch=function(){return"ontouchstart"in window||typeof DocumentTouch<"u"&&document instanceof DocumentTouch},s.getOffset=function(r){var i=r.getBoundingClientRect(),l=document.body.getBoundingClientRect(),a=window.getComputedStyle(document.body),h=i.left-r.scrollLeft-l.left+parseInt(a.marginLeft,10),p=i.top-r.scrollTop-l.top+parseInt(a.marginTop,10);return{x:h,y:p}},s.getScrollOffset=function(r){var i=0,l=0,a=0,h=0;for(r=r.parentNode;r&&r!==document&&r!==document.documentElement;)i+=r.scrollLeft||0,l+=r.scrollTop||0,a+=r.scrollWidth-r.clientWidth||0,h+=r.scrollHeight-r.clientHeight||0,r=r.parentNode;return{x:i,y:l,width:a,height:h}},s.prototype.createPointer=function(r,i){var l=s.getScrollOffset(this.el),a=s.debounce(this.onscroll.bind(this,r),0);return new s.Pointer(r,i.pageX,i.pageY,l,a)},s.prototype.addPointer=function(r){document.addEventListener("scroll",r.onscroll,!0),this.pointers[String(r.identifier)]=r},s.prototype.removePointer=function(r){document.removeEventListener("scroll",r.onscroll,!0),r.context=null,r.onscroll=null,delete this.pointers[String(r.identifier)]},s.prototype.removeAllPointers=function(){Object.keys(this.pointers).forEach(function(r){this.removePointer(this.pointers[r])},this)},s.prototype.hasPointer=function(){return Object.keys(this.pointers).length!==0},s.prototype.findPointer=function(r){return this.pointers[String(r)]||null},s.prototype.resolveUnhandledTouches=function(r){var i=Object.keys(this.pointers);i.length!==0&&i.forEach(function(l){for(var a=this.pointers[l],h=0,p=r.touches.length;h<p;h++)if(r.touches[h].identifier===a.identifier)return;var _=r.pageX-a.startPageX+a.dScrollX,v=r.pageY-a.startPageY+a.dScrollY;this.onend.call(null,_,v,r,a.context),this.removePointer(a)},this)},s.prototype.enable=function(r){this.onstart=r.onstart,this.onmove=r.onmove,this.onend=r.onend;var i=s.supportsTouch()?"touchstart":"mousedown";this.el.addEventListener(i,this["on"+i],{passive:!1})},s.prototype.disable=function(){var r=s.supportsTouch(),i=r?"touchstart":"mousedown",l=r?"touchmove":"mousemove",a=r?"touchend":"mouseup";this.el.removeEventListener(i,this["on"+i],{passive:!1}),document.removeEventListener(l,this["on"+l]),document.removeEventListener(a,this["on"+a]),r||document.removeEventListener("contextmenu",this.onmouseup),this.removeAllPointers()},s.prototype.onmousedown=function(r){var i=s.getOffset(r.target),l=r.clientX-i.x,a=r.clientY-i.y,h=this.createPointer(s.IDENTIFIER_MOUSE,r);this.addPointer(h),this.onstart.call(null,l,a,r,h.context),document.addEventListener("mousemove",this.onmousemove),document.addEventListener("mouseup",this.onmouseup),document.addEventListener("contextmenu",this.onmouseup)},s.prototype.onmousemove=function(r){var i=this.findPointer(s.IDENTIFIER_MOUSE),l=r.pageX-i.startPageX+i.dScrollX,a=r.pageY-i.startPageY+i.dScrollY;this.onmove.call(null,l,a,r,i.context)},s.prototype.onmouseup=function(r){var i=this.findPointer(s.IDENTIFIER_MOUSE),l=r.pageX-i.startPageX+i.dScrollX,a=r.pageY-i.startPageY+i.dScrollY;document.removeEventListener("mousemove",this.onmousemove),document.removeEventListener("mouseup",this.onmouseup),document.removeEventListener("contextmenu",this.onmouseup),this.onend.call(null,l,a,r,i.context),this.removePointer(i)},s.prototype.ontouchstart=function(r){this.resolveUnhandledTouches(r);for(var i=this.hasPointer(),l=r.changedTouches,a=0,h=l.length;a<h;a++){var p=l[a],_=s.getOffset(p.target),v=p.clientX-_.x,x=p.clientY-_.y,y=this.createPointer(p.identifier,p);this.addPointer(y),this.onstart.call(null,v,x,r,y.context)}i||(document.addEventListener("touchmove",this.ontouchmove),document.addEventListener("touchend",this.ontouchend))},s.prototype.ontouchmove=function(r){for(var i=r.changedTouches,l=0,a=i.length;l<a;l++){var h=i[l],p=this.findPointer(h.identifier);if(p!==null){var _=h.pageX-p.startPageX+p.dScrollX,v=h.pageY-p.startPageY+p.dScrollY;this.onmove.call(null,_,v,r,p.context)}}},s.prototype.ontouchend=function(r){for(var i=r.changedTouches,l=0,a=i.length;l<a;l++){var h=i[l],p=this.findPointer(h.identifier);if(p!==null){var _=h.pageX-p.startPageX+p.dScrollX,v=h.pageY-p.startPageY+p.dScrollY;this.onend.call(null,_,v,r,p.context),this.removePointer(p)}}this.hasPointer()||(document.removeEventListener("touchmove",this.ontouchmove),document.removeEventListener("touchend",this.ontouchend))},s.prototype.onscroll=function(r){var i=this.findPointer(r);if(i!==null){var l=s.getScrollOffset(this.el),a=l.width-i.startScrollWidth,h=l.height-i.startScrollHeight;i.dScrollX=l.x-i.startScrollX-a,i.dScrollY=l.y-i.startScrollY-h}},s}();var o=function(s){this.el=s||this.render(),this.parentElement=this.prop(this.el.parentNode),this._relations=[],this._cache={},this._listeners={}};o.prototype.element=function(s){if(typeof s>"u")return this.el;if(s!==this.el){if(!s)throw new Error("missing element");this.el=s,this.parentElement(this.el.parentNode),this._cache={},this.markDirty()}},o.prototype.prop=function(s){var r=s;return function(i){if(typeof i>"u")return r;i!==r&&(r=i,this.markDirty())}},o.prototype.addRelation=function(s){this._relations.indexOf(s)===-1&&this._relations.push(s)},o.prototype.removeRelation=function(s){var r=this._relations.indexOf(s);r!==-1&&this._relations.splice(r,1)},o.prototype.on=function(s,r){this._listeners[s]||(this._listeners[s]=[]),this._listeners[s].push(r)},o.prototype.off=function(s,r){if(this._listeners[s]){var i=this._listeners[s].lastIndexOf(r);i!==-1&&this._listeners[s].splice(i,1)}},o.prototype.emit=function(){var s=Array.prototype.slice.call(arguments),r=s.shift(),i=this._listeners[r];if(i)for(var l=0,a=i.length;l<a;l++)i[l].apply(this,s)},o.prototype.removeAllListeners=function(s){this._listeners[s]?delete this._listeners[s]:this._listeners={}},o.prototype.redraw=function(){var s=this.el,r=this.parentElement();this.onredraw(),r&&r!==s.parentNode?(this.onappend(),r.appendChild(s)):!r&&s.parentNode&&(this.onremove(),s.parentNode.removeChild(s))},o.prototype.redrawBy=function(){for(var s=Array.prototype.slice.call(arguments),r=s.pop(),i=!1,l=[],a=0,h=s.length;a<h;a++){var p=s[a],_=this[p]();_!==this._cache[p]&&(this._cache[p]=_,i=!0),l.push(_)}i&&r.apply(this,l)},o.prototype.markDirty=function(){o.main.markDirty(this)},o.prototype.render=function(){return document.createElement("div")},o.prototype.oninit=function(){},o.prototype.onappend=function(){},o.prototype.onremove=function(){},o.prototype.onredraw=function(){},o.main=function(){var s=function(){this.dirtyComponents=[],this.requestID=0};return s.prototype.markDirty=function(r){this.dirtyComponents.lastIndexOf(r)===-1&&this.dirtyComponents.push(r),!this.requestID&&(this.requestID=window.requestAnimationFrame(this.onanimate.bind(this)))},s.prototype.update=function(r){for(var i=r,l=this.dirtyComponents.length;i<l;i++)for(var a=this.dirtyComponents[i],h=a._relations,p=0,_=h.length;p<_;p++)h[p].update(a);this.dirtyComponents.length>l&&this.update(l)},s.prototype.onanimate=function(){this.update(0);for(var r=0,i=this.dirtyComponents.length;r<i;r++)this.dirtyComponents[r].redraw();this.dirtyComponents=[],this.requestID=0},new s}(),o.inherits=function(s){var r=this,i=function(){r.apply(this,arguments),typeof s=="function"&&s.apply(this,arguments),this.constructor===i&&this.oninit()};return e(i,r),i.inherits=r.inherits,i};var c=function(){};c.prototype.update=function(s){},c.inherits=function(s){var r=this,i=function(){typeof s=="function"&&s.apply(this,arguments)};return e(i,r),i};var d=function(s){this._component=s,this._draggable=new n.Draggable(s.el)};d.prototype.enable=function(){this._draggable.enable({onstart:this.onstart.bind(this,this._component),onmove:this.onmove.bind(this,this._component),onend:this.onend.bind(this,this._component)})},d.prototype.disable=function(){this._draggable.disable()},d.prototype.onstart=function(s,r,i,l,a){},d.prototype.onmove=function(s,r,i,l,a){},d.prototype.onend=function(s,r,i,l,a){},d.inherits=function(s){var r=this,i=function(){r.apply(this,arguments),typeof s=="function"&&s.apply(this,arguments)};return e(i,r),i};var m={Component:o,Relation:c,Draggable:d};typeof t<"u"&&t.exports?t.exports=m:window.jCore=m})()}}),g=G();var L=class f extends g.Component{constructor(t){super(t),this.disabled=this.prop(!1),this._needsFocus=!1,this._needsBlur=!1,this._history=new D({size:100,key:"playbuild/input-history"}),this._oninit()}focus(){this._needsFocus=!0,this._needsBlur=!1,this.markDirty()}blur(){this._needsFocus=!1,this._needsBlur=!0,this.markDirty()}onredraw(){this.redrawBy("disabled",t=>{u.disabled(this.el,t)}),this._needsFocus&&(u.focus(this.el),this._needsFocus=!1),this._needsBlur&&(u.blur(this.el),this._needsBlur=!1)}_text(t){return u.value(this.el,t)}_isError(t){u.toggleClass(this.el,"error",t)}_oninit(){this._history.load(),u.on(this.el,"keydown",this._onkeydown.bind(this))}_onkeydown(t){let e=f._KEY_DOWN_MAP[u.key(t)];e&&(this._isError(!1),this[`_on${e}`](t))}_onenter(){let t=this._text();t&&this.emit("exec",t,this._onexec.bind(this))}_onup(t){u.cancel(t),this._text(this._history.back())}_ondown(t){u.cancel(t),this._text(this._history.forward())}_onexec(t){if(t){this._isError(!0),u.once(this.el,"input",this._oninput.bind(this));return}this._history.push(this._text()),this._history.save(),this._text("")}_oninput(){this._isError(!1)}static _KEY_DOWN_MAP={Enter:"enter",ArrowUp:"up",ArrowDown:"down"}},D=class{constructor(t){this._data=[],this._index=0,this._size=t.size,this._key=t.key}push(t){this._data.push(t),this._data.splice(0,this._data.length-this._size),this._index=this._data.length}back(){return this._index=Math.max(this._index-1,0),this._current()}forward(){return this._index=Math.min(this._index+1,this._data.length),this._current()}load(){this._data=u.load(this._key,[]),this._index=this._data.length}save(){u.save(this._key,this._data)}_current(){return this._data[this._index]||""}};var P=class f extends g.Component{constructor(t){super(),this.top=this.prop(t.top),this.dragging=this.prop(!1),this._name=t.name,this._moduleName=t.moduleName,this._content=new j(u.find(this.el,".variable-content")),this._opened=!0,this._onchange_toggleButton=this._onchange_toggleButton.bind(this),this._onclick_deleteButton=this._onclick_deleteButton.bind(this),this._oninit()}name(){return this._name}height(){return this._opened&&!this.dragging()?this._content.height()+f._HEIGHT_OFFSET_OPENED:f._HEIGHT_OFFSET_CLOSED}circuitModule(){return this._content.circuitModule()}render(){return u.render(f._HTML_TEXT)}load(t){return this._content.load(this._contentUrl(),t)}unload(){u.off(this._toggleButtonElement(),"change",this._onchange_toggleButton),u.off(this._deleteButtonElement(),"click",this._onclick_deleteButton)}onredraw(){this.redrawBy("top",t=>{u.translateY(this.el,t)}),this.redrawBy("dragging",t=>{u.toggleClass(this.el,"dragging",t)})}_toggleButtonElement(){return u.find(this.el,".variable-toggle-button")}_nameElement(){return u.find(this.el,".variable-name")}_deleteButtonElement(){return u.find(this.el,".variable-delete-button")}_contentUrl(){return`playbuild_modules/${encodeURI(this._moduleName)}.html`}_oninit(){u.data(this.el,"name",this._name),u.text(this._nameElement(),`${this._name}:${this._moduleName}`),u.on(this._toggleButtonElement(),"change",this._onchange_toggleButton),u.on(this._deleteButtonElement(),"click",this._onclick_deleteButton)}_onchange_toggleButton(t){this._opened=u.checked(u.target(t)),u.toggleClass(this.el,"open",this._opened),this.emit("resize")}_onclick_deleteButton(){this.emit("delete")}static _HEIGHT_OFFSET_OPENED=33;static _HEIGHT_OFFSET_CLOSED=32;static _HTML_TEXT=['<div class="variable open">','<div class="variable-header">','<div class="variable-toggle-button">','<input class="variable-toggle-button-input" type="checkbox" name="variable-toggle" checked ontouchstart="">','<svg class="variable-toggle-button-image" viewBox="0 0 7 12">','<path d="M 1 1 L 6 6 1 11" stroke="#616161" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" fill="none" />',"</svg>","</div>",'<div class="variable-name"></div>','<button class="variable-delete-button">','<svg class="variable-delete-button-image" viewBox="0 0 12 12">','<path d="M 1 1 L 11 11 M 11 1 L 1 11" stroke="#616161" stroke-width="1" stroke-linecap="round" fill="none" />',"</svg>","</button>","</div>",'<iframe class="variable-content embed"></iframe>',"</div>"].join("")},j=class extends g.Component{constructor(t){super(t),this._height=0}height(){return this._height}circuitModule(){let t=this._contentWindow().playbuild||null;return t&&t.exports}async load(t,e){if(!await new Promise((o,c)=>{let d=setTimeout(c,3e4,new Error("PlayBuildScript runtime error: Load timeout for content"));u.once(this.el,"load",()=>{clearTimeout(d);let m=this.circuitModule();m&&m.deserialize(e),o(m)}),u.attr(this.el,{src:t})}))throw new Error("PlayBuildScript runtime error: Invalid circuit module");this._height=u.contentHeight(this.el),u.css(this.el,{height:`${this._height}px`})}_contentWindow(){return u.contentWindow(this.el)}};var k=class f extends g.Component{constructor(t){super(t),this._height=this.prop(0),this._dragCount=this.prop(0),this._variables=[],this._draggable=new N(this),this._onresize_variable=this._onresize_variable.bind(this),this._oninit()}incrementDragCount(){this._dragCount(this._dragCount()+1)}decrementDragCount(){this._dragCount(this._dragCount()-1)}findVariable(t){return this._variables.find(e=>e.name()===t)}async loadVariable(t,e,n){let o=this.findVariable(t);if(o)return o;let c=f._VARIABLE_MARGIN,d=this._variables.reduce((m,s)=>m+s.height()+c,c);o=new P({name:t,moduleName:e,top:d}),o.parentElement(this.el),o.redraw();try{return await o.load(n),o.on("resize",this._onresize_variable),o.on("delete",this.emit.bind(this,"delete-variable",o.name())),this._variables.push(o),this._onresize_variable(),o}catch(m){throw o.parentElement(null),m}}deleteVariable(t){let e=this.findVariable(t);e&&(e.unload(),e.removeAllListeners(),e.parentElement(null),b.remove(this._variables,e),this._onresize_variable())}moveVariable(t,e){t.top(e),this._onresize_variable()}reorder(){let t=this._variables.map(o=>o.name()),e=f._reorderVariables(this._variables).map(o=>o.name());!e.every((o,c)=>o===t[c])&&this.emit("reorder-variables",e),this._onresize_variable()}onredraw(){this.redrawBy("_height",t=>{u.css(this.el,{height:`${t}px`})}),this.redrawBy("_dragCount",t=>{u.toggleClass(this.el,"dragging",t>0)})}_oninit(){this._draggable.enable()}_onresize_variable(){if(this._variables.length===0){this._height(0);return}let t=f._VARIABLE_MARGIN,e=f._reorderVariables(this._variables.slice()).reduce((n,o)=>(o.dragging()||o.top(n),n+o.height()+t),t);this._height(e)}static _VARIABLE_MARGIN=24;static _reorderVariables(t){return t.sort((e,n)=>{let o=e.top(),c=n.top();return o-c===0?e.dragging()?-1:n.dragging()?1:0:o-c})}},N=class f extends g.Draggable{constructor(t){super(t)}onstart(t,e,n,o,c){c.variable=f._findVariableByTarget(t,u.target(o)),c.variable&&(u.cancel(o),t.incrementDragCount(),c.top=c.variable.top())}onmove(t,e,n,o,c){c.variable&&(c.variable.dragging(!0),t.moveVariable(c.variable,c.top+n))}onend(t,e,n,o,c){c.variable&&(t.decrementDragCount(),c.variable.dragging(!1),t.reorder())}static _findVariableByTarget(t,e){if(!u.hasClass(e,"variable-header"))return null;let n=u.data(u.parent(e),"name");return t.findVariable(n)}};var M=class f{static parse(t){let e=f._tokenize(t),n=f._makeNodes(e);if(!f._isValidNodes(n))throw new SyntaxError(`PlayBuildScript parse error: Unexpected identifier "${t}"`);return f._makeArgs(n)}static parseList(t){let e=!1,n=!1,o=[];for(let c=0;c<t.length;c++)t[c]==='"'&&t[c-1]!=="\\"&&!n?e=!e:t[c]==="'"&&t[c-1]!=="\\"&&!e?n=!n:t[c]===";"&&!n&&!e&&o.push(c);if(e||n)throw new SyntaxError(`PlayBuildScript parse error: Invalid command line string "${t}"`);return t[t.length-1]!==";"&&o.push(t.length),o.map((c,d)=>t.substring(d!==0?o[d-1]+1:0,c))}static _tokenize(t){let e=t.match(/".*?[^\\]"|'.*?[^\\]'|\.|#|:|>>|<<|[\w"'/\\]+|\S+/g)||[],n=e.indexOf("#");return n!==-1?e.slice(0,n):e}static _makeNodes(t){let e=t.slice();return e[0]===":"&&e.length>=2?(e.shift(),e[0]=`:${e[0].toLowerCase()}`):e[1]===":"?(e.splice(1,1),e.unshift(":new")):e[1]==="."&&e[3]===">>"&&e[5]==="."?(e.splice(3,1),e.unshift(":bind")):e[1]==="."&&e[3]==="<<"&&(e.splice(3,1),e.unshift(":send")),e}static _isValidNodes(t){switch(t[0]){case":new":return t.length>=3&&t.length<=4&&/^[a-zA-Z]/.test(t[1])&&/^[a-zA-Z]/.test(t[2]);case":bind":case":unbind":return t.length===7&&t[2]==="."&&t[5]===".";case":send":return t.length>=4&&t.length<=5&&t[2]===".";case":delete":return t.length===2&&/^[a-zA-Z]/.test(t[1]);case":reset":return t.length===1;case":load":case":save":return t.length<=2;default:return t.length===0}}static _makeArgs(t){return t.filter(e=>e!==".").map(e=>{let n=e.charAt(0),o=e.slice(-1);return n===o&&(n==="'"||n==='"')&&(e=e.slice(1,-1)),e.replace(/\\(["'])/g,"$1")})}};var B=class f{constructor(t){this._circuitModuleLoader=t.circuitModuleLoader,this._circuitModuleUnloader=t.circuitModuleUnloader,this._scriptLoader=t.scriptLoader,this._scriptSaver=t.scriptSaver,this._variables=[],this._bindings=[]}async exec(t){typeof t=="string"&&(t=M.parseList(t));for(let e of t){let n=M.parse(e);if(n.length===0)return;let o=n.shift();await f._EXEC_TABLE[o].apply(this,n)}}async deleteVariable(t){return await f._EXEC_TABLE[":delete"].call(this,t)}async loadScript(t){return await f._EXEC_TABLE[":load"].call(this,t)}reorderVariables(t){let e=t.length;if(e!==this._variables.length)throw new Error("failed to reorder variables");let n=this._variables.slice(),o=new Array(e);for(let c=0;c<e;c++){let d=t[c],m=n.findIndex(s=>s&&s.name===d);if(m===-1)throw new Error("failed to reorder variables");o[c]=n[m],n[m]=null}this._variables=o}_findVariable(t){return this._variables.find(e=>e.name===t)}_findVariableByMember(t){return this._variables.find(e=>e.circuitModule.get(t.name)===t)}_findBinding(t,e){return this._bindings.find(n=>n.sourceMember===t&&n.targetMember===e)}_fetchMember(t,e){let n=this._findVariable(t);if(!n)throw new Error(`PlayBuildScript runtime error: variable "${t}" is not defined`);let o=n.circuitModule.get(e);if(!o)throw new Error(`PlayBuildScript runtime error: member "${t}.${e}" is not defined`);return o}async _loadVariable(t,e,n){let o=await this._circuitModuleLoader(t,e,n);if(!o)throw new Error("PlayBuildScript runtime error: Invalid circuit module");this._variables.push(new V({name:t,moduleName:e,circuitModule:o}))}async _unloadVariable(t){await this._circuitModuleUnloader(t),this._deleteVariable(t)}_deleteVariable(t){let e=this._findVariable(t);this._bindings.filter(n=>this._findVariableByMember(n.sourceMember)===e||this._findVariableByMember(n.targetMember)===e).forEach(n=>{w.unbind(n.sourceMember,n.targetMember),b.remove(this._bindings,n)}),b.remove(this._variables,e)}_bind(t,e){if(this._findBinding(t,e))throw new Error("PlayBuildScript runtime error: Already bound");w.bind(t,e),this._bindings.push(new F({sourceMember:t,targetMember:e}))}_unbind(t,e){let n=this._findBinding(t,e);if(!n)throw new Error("PlayBuildScript runtime error: Not bound");w.unbind(t,e),b.remove(this._bindings,n)}async _loadScript(t,e){for(let[n,o]of t.split(/\r\n|\r|\n/g).entries())try{await this.exec(o)}catch(c){throw new SyntaxError(c.message,e,n+1)}}_generateScript(){let t=this._variables.map(o=>{let c=`${o.name}:${o.moduleName}`,d=o.circuitModule.serialize();return d!=null&&(c+=` '${d.replace(/'/g,"\\'")}'`),c}).join(`
`),e=this._bindings.map(o=>{let c=`${this._findVariableByMember(o.sourceMember).name}.${o.sourceMember.name}`,d=`${this._findVariableByMember(o.targetMember).name}.${o.targetMember.name}`;return`${c} >> ${d}`}).join(`
`);return`${`${t}
${e}`.trim()}
`}static _EXEC_TABLE={":new"(t,e,n){if(this._findVariable(t))throw new Error(`PlayBuildScript runtime error: variable "${t}" is already defined`);return this._loadVariable(t,e,n)},":bind"(t,e,n,o){let c=this._fetchMember(t,e),d=this._fetchMember(n,o);this._bind(c,d)},":unbind"(t,e,n,o){let c=this._fetchMember(t,e),d=this._fetchMember(n,o);this._unbind(c,d)},":send"(t,e,n){this._fetchMember(t,e)(n)},":delete"(t){if(!this._findVariable(t))throw new Error(`PlayBuildScript runtime error: variable "${t}" is not defined`);return this._unloadVariable(t)},":reset"(){return Promise.all(this._variables.map(t=>this._unloadVariable(t.name)))},async":load"(t){let e=await this._scriptLoader(t);return this._loadScript(e.text,e.fileName)},":save"(t){return this._scriptSaver(t,this._generateScript())}}},V=class{constructor(t){this.name=t.name,this.moduleName=t.moduleName,this.circuitModule=t.circuitModule}},F=class{constructor(t){this.sourceMember=t.sourceMember,this.targetMember=t.targetMember}};var C=class extends g.Component{constructor(t){super(t)}async load(){let t=await new Promise(o=>{let c=d=>{o(u.file(u.target(d)))};u.on(this.el,"change",c),u.click(this.el),u.once(u.body(),"focus",()=>{u.off(this.el,"change",c)},!0)}),e=u.fileName(t);return u.value(this.el,""),{text:await u.readFile(t),fileName:e}}};var O=class extends g.Component{constructor(t){super(t),this._env=new B({circuitModuleLoader:this._circuitModuleLoader.bind(this),circuitModuleUnloader:this._circuitModuleUnloader.bind(this),scriptLoader:this._scriptLoader.bind(this),scriptSaver:this._scriptSaver.bind(this)}),this._commandInput=new L(u.find(this.el,".command-input")),this._fileInput=new C(u.find(this.el,".file-input")),this._content=new k(u.find(this.el,".content")),this._oninit()}async loadStartupScript(){this._commandInput.disabled(!0);let t=u.urlQuery(u.location(),"demo"),e=t!==null?`demo/${t}.pb`:"init.pb";try{await this._env.loadScript(e)}catch(n){console.error(n)}this._commandInput.disabled(!1)}async _circuitModuleLoader(t,e,n){return(await this._content.loadVariable(t,e,n)).circuitModule()}async _circuitModuleUnloader(t){this._content.deleteVariable(t)}async _scriptLoader(t){if(!t)return this._commandInput.disabled(!1),this._commandInput.blur(),this._fileInput.load();let e=await fetch(`playbuild_scripts/${t}`);if(!e.ok)throw new Error(e.statusText);let n=await e.text(),o=t.split("/").pop();return{text:n,fileName:o}}async _scriptSaver(t,e){R.saveAs(new Blob([e],{type:"plain/text"}),t)}_oninit(){this._commandInput.on("exec",this._onexec.bind(this)),this._commandInput.focus(),this._content.on("delete-variable",this._ondelete_variable.bind(this)),this._content.on("reorder-variables",this._onreorder_variables.bind(this))}async _onexec(t,e){this._commandInput.disabled(!0);try{await this._env.exec(t),e()}catch(n){console.error(n),e(n)}this._commandInput.disabled(!1),this._commandInput.focus()}_ondelete_variable(t){this._env.deleteVariable(t)}_onreorder_variables(t){this._env.reorderVariables(t)}};u.export("PlayBuildModule",w.PlayBuildModule);var J=new O(u.body());J.loadStartupScript();})();
