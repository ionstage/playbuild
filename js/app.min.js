(()=>{var h=class u{static export(t,n){Object.defineProperty(typeof global<"u"?global:window,t,{value:n})}static body(){return document.body}static render(t){let n=document.createRange().createContextualFragment(t).firstChild;return n.parentNode.removeChild(n),n}static find(t,n){return t.querySelector(n)}static attr(t,n){Object.keys(n).forEach(i=>{t.setAttribute(i,n[i])})}static css(t,n){let i=t.style;Object.keys(n).forEach(c=>{i[c]=n[c]})}static toggleClass(t,n,i){i?t.classList.add(n):t.classList.remove(n)}static text(t,n){t.textContent=n}static value(t,n){if(typeof n>"u")return t.value;t.value=n}static disabled(t,n){t.disabled=n}static focus(t){t.focus()}static blur(t){t.blur()}static file(t){return t.files[0]}static contentWindow(t){return t.contentWindow}static contentHeight(t){return t.contentDocument.documentElement.scrollHeight}static on(t,n,i,c){t.addEventListener(n,i,!!c)}static off(t,n,i,c){t.removeEventListener(n,i,!!c)}static once(t,n,i,c){let p=()=>{u.off(t,n,p,c),i.apply(null,arguments)};u.on(t,n,p,c)}static click(t){t.click()}static target(t){return t.target}static cancel(t){t.preventDefault()}static readFile(t){return new Promise((n,i)=>{let c=new FileReader,p=()=>{i(new Error("Failed to read file: "+t.name))};c.onload=d=>{n(d.target.result)},c.onerror=p,c.onabort=p,c.readAsText(t)})}static fileName(t){return t.name}static ajax(t){let n=t.type,i=t.url;return new Promise((c,p)=>{let d=new XMLHttpRequest,v=()=>{p(new Error("Failed to load resource: "+n+" "+i))};d.onload=()=>{d.status>=200&&d.status<400?c(d.response):v()},d.onerror=v,d.onabort=v,d.open(n,i,!0),d.send()})}static load(t,n){return JSON.parse(localStorage.getItem(t))||n}static save(t,n){localStorage.setItem(t,JSON.stringify(n))}};var U=Object.getOwnPropertyNames,F=(u,t)=>function(){return t||(0,u[U(u)[0]])((t={exports:{}}).exports,t),t.exports},q=F({"node_modules/circuit/circuit.js"(u,t){(function(n){"use strict";var i=function(e,r){for(var a=e.length-1;a>=0;a--)if(e[a]===r)return a;return-1},c=function(e,r){for(var a=e.length,s=Array(a),l=0;l<a;l++)s[l]=r(e[l],l,e);return s},p=function(e){return e},d={},v=function(e){var r=this,a=function(){if(typeof arguments[0]>"u")return r.update(),r.cache;var s=r.value.apply(null,arguments);s!==r.cache&&(r.updateCache(s),r.markDirty())};return a._self=r,this.func=a,this.targets=[],this.sources=[],typeof e!="function"?(this.cache=e,this.value=p,this.dirty=!1,this.timer=null):(this.value=e,this.dirty=!0,this.timer=setTimeout(function(){r.timer=null,r.dirty=!0,r.update()},0)),a};v.prototype.update=function(){if(this.dirty){this.dirty=!1;var e=c(this.sources,function(a){return a()}),r=this.value.apply(null,e);r!==this.cache&&(this.updateCache(r),this.markDirty())}},v.prototype.updateCache=function(e){this.cache=e,this.dirty=!1},v.prototype.markDirty=function(){if(v.markDirtyTargets(this.targets),!!this.dirty&&(this.dirty=!1,this.timer===null)){var e=this;this.timer=setTimeout(function(){e.timer=null,e.dirty=!0,e.update()},0)}},v.markDirtyTargets=function(){var e=[],r=null;return function(a){for(var s=0,l=a.length;s<l;s++){var f=a[s],m=f._self;m.dirty||(m.dirty=!0,i(e,f)===-1&&e.push(f),v.markDirtyTargets(m.targets))}r===null&&(r=setTimeout(function y(){var E=e.slice();e=[];for(var w=0,S=E.length;w<S;w++){var R=E[w];R._self.dirty&&R()}e.length!==0&&y(),r=null},0))}}();var o=function(e){var r=this,a=function(s){var l=!1;typeof s>"u"&&(s=null);var f=function(y){if(typeof y>"u")return s;s=y},m={cancel:function(){l=!0},dispatch:function(){r.dispatch(f())},context:f};typeof e=="function"&&e(m),!l&&r.dispatch(f())};return a._self=r,this.func=a,this.targets=[],this.sources=[],a};o.prototype.dispatch=function(e){var r=this.targets;setTimeout(function(){for(var a=0,s=r.length;a<s;a++)r[a](e)},0)},d.data=function(e){return new v(e)},d.prop=d.data,d.event=function(e){return new o(e)},d.bind=function(e,r){if(!e||!r)throw new TypeError("Not enough arguments");var a=e._self,s=r._self;if(a.constructor!==s.constructor)throw new TypeError("Cannot bind data and event");a.targets.push(r),s.sources.push(e),a.constructor===v&&(v.markDirtyTargets([r]),e())},d.unbind=function(e,r){if(!e||!r)throw new TypeError("Not enough arguments");var a=e._self,s=r._self,l=i(a.targets,r);if(l===-1)throw new Error("Already unbound");s.constructor===v&&s.dirty&&r();var f=i(s.sources,e);s.sources.splice(f,1),a.targets.splice(l,1)},typeof t<"u"&&t.exports?t.exports=d:n.circuit=d})(u)}}),P=q();var g=class{static values(t){return Object.keys(t).map(n=>t[n])}static remove(t,n){let i=t.indexOf(n);i!==-1&&t.splice(i,1)}static find(t,n){for(let i=0,c=t.length;i<c;i++)if(n(t[i],i,t))return t[i];return null}static wrapper=()=>class D{constructor(n,i){return Object.defineProperty(i,"unwrap",{value:D.unwrap.bind(n)})}static unwrap(n){return n===D.KEY?this:null}static KEY={}}};var T=g.wrapper(),x=class u{constructor(t){this.memberTable=t}get(t){return this.memberTable[t]||null}static bind(t,n){let i=t.unwrap(T.KEY).callee,c=n.unwrap(T.KEY).callee;P.bind(i,c)}static unbind(t,n){let i=t.unwrap(T.KEY).callee,c=n.unwrap(T.KEY).callee;P.unbind(i,c)}static PlayBuildModule=class{constructor(t){return new u(t.reduce((n,i)=>(n[i.name]=new I(i),n),{}))}}},I=class{constructor(t){return this.callee=P[t.type](t.arg),this.wrapper(t.name)}call(){return this.callee.apply(this,arguments)}wrapper(t){let n=new T(this,this.call.bind(this));return Object.defineProperty(n,"name",{value:t})}};var H=Object.getOwnPropertyNames,V=(u,t)=>function(){return t||(0,u[H(u)[0]])((t={exports:{}}).exports,t),t.exports},W=V({"node_modules/file-saver/dist/FileSaver.min.js"(u,t){(function(n,i){typeof define=="function"&&define.amd?define([],i):typeof u<"u"?i():(i(),n.FileSaver={})})(u,function(){"use strict";function n(e,r){return typeof r>"u"?r={autoBom:!1}:typeof r!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\uFEFF",e],{type:e.type}):e}function i(e,r,a){var s=new XMLHttpRequest;s.open("GET",e),s.responseType="blob",s.onload=function(){o(s.response,r,a)},s.onerror=function(){console.error("could not download file")},s.send()}function c(e){var r=new XMLHttpRequest;r.open("HEAD",e,!1);try{r.send()}catch{}return 200<=r.status&&299>=r.status}function p(e){try{e.dispatchEvent(new MouseEvent("click"))}catch{var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(r)}}var d=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof global=="object"&&global.global===global?global:void 0,v=d.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),o=d.saveAs||(typeof window!="object"||window!==d?function(){}:"download"in HTMLAnchorElement.prototype&&!v?function(e,r,a){var s=d.URL||d.webkitURL,l=document.createElement("a");r=r||e.name||"download",l.download=r,l.rel="noopener",typeof e=="string"?(l.href=e,l.origin===location.origin?p(l):c(l.href)?i(e,r,a):p(l,l.target="_blank")):(l.href=s.createObjectURL(e),setTimeout(function(){s.revokeObjectURL(l.href)},4e4),setTimeout(function(){p(l)},0))}:"msSaveOrOpenBlob"in navigator?function(e,r,a){if(r=r||e.name||"download",typeof e!="string")navigator.msSaveOrOpenBlob(n(e,a),r);else if(c(e))i(e,r,a);else{var s=document.createElement("a");s.href=e,s.target="_blank",setTimeout(function(){p(s)})}}:function(e,r,a,s){if(s=s||open("","_blank"),s&&(s.document.title=s.document.body.innerText="downloading..."),typeof e=="string")return i(e,r,a);var l=e.type==="application/octet-stream",f=/constructor/i.test(d.HTMLElement)||d.safari,m=/CriOS\/[\d]+/.test(navigator.userAgent);if((m||l&&f||v)&&typeof FileReader<"u"){var y=new FileReader;y.onloadend=function(){var S=y.result;S=m?S:S.replace(/^data:[^;]*;/,"data:attachment/file;"),s?s.location.href=S:location=S,s=null},y.readAsDataURL(e)}else{var E=d.URL||d.webkitURL,w=E.createObjectURL(e);s?s.location=w:location.href=w,s=null,setTimeout(function(){E.revokeObjectURL(w)},4e4)}});d.saveAs=o.saveAs=o,typeof t<"u"&&(t.exports=o)})}}),B=W();var K=Object.getOwnPropertyNames,z=(u,t)=>function(){return t||(0,u[K(u)[0]])((t={exports:{}}).exports,t),t.exports},J=z({"node_modules/jcore/jcore.js"(u,t){(function(){"use strict";window.requestAnimationFrame||(window.requestAnimationFrame=function(o){return setTimeout(o,1e3/60)});var n=function(o,e){o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}})},i={};i.Draggable=function(){var o=function(e){this.el=e,this.onstart=null,this.onmove=null,this.onend=null,this.onmousedown=this.onmousedown.bind(this),this.onmousemove=this.onmousemove.bind(this),this.onmouseup=this.onmouseup.bind(this),this.ontouchstart=this.ontouchstart.bind(this),this.ontouchmove=this.ontouchmove.bind(this),this.ontouchend=this.ontouchend.bind(this),this.pointers={}};return o.IDENTIFIER_MOUSE=0,o.Pointer=function(e,r,a,s,l){this.identifier=e,this.startPageX=r,this.startPageY=a,this.startScrollX=s.x,this.startScrollY=s.y,this.startScrollWidth=s.width,this.startScrollHeight=s.height,this.dScrollX=0,this.dScrollY=0,this.context={},this.onscroll=l},o.debounce=function(e,r){var a=0,s=null,l=null;return function(){s=this,l=arguments,a&&clearTimeout(a),a=setTimeout(function(){e.apply(s,l),a=0,s=null,l=null},r)}},o.supportsTouch=function(){return"ontouchstart"in window||typeof DocumentTouch<"u"&&document instanceof DocumentTouch},o.getOffset=function(e){var r=e.getBoundingClientRect(),a=document.body.getBoundingClientRect(),s=window.getComputedStyle(document.body),l=r.left-e.scrollLeft-a.left+parseInt(s.marginLeft,10),f=r.top-e.scrollTop-a.top+parseInt(s.marginTop,10);return{x:l,y:f}},o.getScrollOffset=function(e){var r=0,a=0,s=0,l=0;for(e=e.parentNode;e&&e!==document&&e!==document.documentElement;)r+=e.scrollLeft||0,a+=e.scrollTop||0,s+=e.scrollWidth-e.clientWidth||0,l+=e.scrollHeight-e.clientHeight||0,e=e.parentNode;return{x:r,y:a,width:s,height:l}},o.prototype.createPointer=function(e,r){var a=o.getScrollOffset(this.el),s=o.debounce(this.onscroll.bind(this,e),0);return new o.Pointer(e,r.pageX,r.pageY,a,s)},o.prototype.addPointer=function(e){document.addEventListener("scroll",e.onscroll,!0),this.pointers[String(e.identifier)]=e},o.prototype.removePointer=function(e){document.removeEventListener("scroll",e.onscroll,!0),e.context=null,e.onscroll=null,delete this.pointers[String(e.identifier)]},o.prototype.removeAllPointers=function(){Object.keys(this.pointers).forEach(function(e){this.removePointer(this.pointers[e])},this)},o.prototype.hasPointer=function(){return Object.keys(this.pointers).length!==0},o.prototype.findPointer=function(e){return this.pointers[String(e)]||null},o.prototype.resolveUnhandledTouches=function(e){var r=Object.keys(this.pointers);r.length!==0&&r.forEach(function(a){for(var s=this.pointers[a],l=0,f=e.touches.length;l<f;l++)if(e.touches[l].identifier===s.identifier)return;var m=e.pageX-s.startPageX+s.dScrollX,y=e.pageY-s.startPageY+s.dScrollY;this.onend.call(null,m,y,e,s.context),this.removePointer(s)},this)},o.prototype.enable=function(e){this.onstart=e.onstart,this.onmove=e.onmove,this.onend=e.onend;var r=o.supportsTouch()?"touchstart":"mousedown";this.el.addEventListener(r,this["on"+r],{passive:!1})},o.prototype.disable=function(){var e=o.supportsTouch(),r=e?"touchstart":"mousedown",a=e?"touchmove":"mousemove",s=e?"touchend":"mouseup";this.el.removeEventListener(r,this["on"+r],{passive:!1}),document.removeEventListener(a,this["on"+a]),document.removeEventListener(s,this["on"+s]),this.removeAllPointers()},o.prototype.onmousedown=function(e){var r=o.getOffset(e.target),a=e.clientX-r.x,s=e.clientY-r.y,l=this.createPointer(o.IDENTIFIER_MOUSE,e);this.addPointer(l),this.onstart.call(null,a,s,e,l.context),document.addEventListener("mousemove",this.onmousemove),document.addEventListener("mouseup",this.onmouseup)},o.prototype.onmousemove=function(e){var r=this.findPointer(o.IDENTIFIER_MOUSE),a=e.pageX-r.startPageX+r.dScrollX,s=e.pageY-r.startPageY+r.dScrollY;this.onmove.call(null,a,s,e,r.context)},o.prototype.onmouseup=function(e){var r=this.findPointer(o.IDENTIFIER_MOUSE),a=e.pageX-r.startPageX+r.dScrollX,s=e.pageY-r.startPageY+r.dScrollY;document.removeEventListener("mousemove",this.onmousemove),document.removeEventListener("mouseup",this.onmouseup),this.onend.call(null,a,s,e,r.context),this.removePointer(r)},o.prototype.ontouchstart=function(e){this.resolveUnhandledTouches(e);for(var r=this.hasPointer(),a=e.changedTouches,s=0,l=a.length;s<l;s++){var f=a[s],m=o.getOffset(f.target),y=f.clientX-m.x,E=f.clientY-m.y,w=this.createPointer(f.identifier,f);this.addPointer(w),this.onstart.call(null,y,E,e,w.context)}r||(document.addEventListener("touchmove",this.ontouchmove),document.addEventListener("touchend",this.ontouchend))},o.prototype.ontouchmove=function(e){for(var r=e.changedTouches,a=0,s=r.length;a<s;a++){var l=r[a],f=this.findPointer(l.identifier);if(f!==null){var m=l.pageX-f.startPageX+f.dScrollX,y=l.pageY-f.startPageY+f.dScrollY;this.onmove.call(null,m,y,e,f.context)}}},o.prototype.ontouchend=function(e){for(var r=e.changedTouches,a=0,s=r.length;a<s;a++){var l=r[a],f=this.findPointer(l.identifier);if(f!==null){var m=l.pageX-f.startPageX+f.dScrollX,y=l.pageY-f.startPageY+f.dScrollY;this.onend.call(null,m,y,e,f.context),this.removePointer(f)}}this.hasPointer()||(document.removeEventListener("touchmove",this.ontouchmove),document.removeEventListener("touchend",this.ontouchend))},o.prototype.onscroll=function(e){var r=this.findPointer(e);if(r!==null){var a=o.getScrollOffset(this.el),s=a.width-r.startScrollWidth,l=a.height-r.startScrollHeight;r.dScrollX=a.x-r.startScrollX-s,r.dScrollY=a.y-r.startScrollY-l}},o}();var c=function(o){this.el=o||this.render(),this.parentElement=this.prop(this.el.parentNode),this._relations=[],this._cache={},this._listeners={}};c.prototype.element=function(o){if(typeof o>"u")return this.el;if(o!==this.el){if(!o)throw new Error("missing element");this.el=o,this.parentElement(this.el.parentNode),this._cache={},this.markDirty()}},c.prototype.prop=function(o){var e=o;return function(r){if(typeof r>"u")return e;r!==e&&(e=r,this.markDirty())}},c.prototype.addRelation=function(o){this._relations.indexOf(o)===-1&&this._relations.push(o)},c.prototype.removeRelation=function(o){var e=this._relations.indexOf(o);e!==-1&&this._relations.splice(e,1)},c.prototype.on=function(o,e){this._listeners[o]||(this._listeners[o]=[]),this._listeners[o].push(e)},c.prototype.off=function(o,e){if(this._listeners[o]){var r=this._listeners[o].lastIndexOf(e);r!==-1&&this._listeners[o].splice(r,1)}},c.prototype.emit=function(){var o=Array.prototype.slice.call(arguments),e=o.shift(),r=this._listeners[e];if(r)for(var a=0,s=r.length;a<s;a++)r[a].apply(this,o)},c.prototype.removeAllListeners=function(o){this._listeners[o]?delete this._listeners[o]:this._listeners={}},c.prototype.redraw=function(){var o=this.el,e=this.parentElement();this.onredraw(),e&&e!==o.parentNode?(this.onappend(),e.appendChild(o)):!e&&o.parentNode&&(this.onremove(),o.parentNode.removeChild(o))},c.prototype.redrawBy=function(){for(var o=Array.prototype.slice.call(arguments),e=o.pop(),r=!1,a=[],s=0,l=o.length;s<l;s++){var f=o[s],m=this[f]();m!==this._cache[f]&&(this._cache[f]=m,r=!0),a.push(m)}r&&e.apply(this,a)},c.prototype.markDirty=function(){c.main.markDirty(this)},c.prototype.render=function(){return document.createElement("div")},c.prototype.oninit=function(){},c.prototype.onappend=function(){},c.prototype.onremove=function(){},c.prototype.onredraw=function(){},c.main=function(){var o=function(){this.dirtyComponents=[],this.requestID=0};return o.prototype.markDirty=function(e){this.dirtyComponents.lastIndexOf(e)===-1&&this.dirtyComponents.push(e),!this.requestID&&(this.requestID=window.requestAnimationFrame(this.onanimate.bind(this)))},o.prototype.update=function(e){for(var r=e,a=this.dirtyComponents.length;r<a;r++)for(var s=this.dirtyComponents[r],l=s._relations,f=0,m=l.length;f<m;f++)l[f].update(s);this.dirtyComponents.length>a&&this.update(a)},o.prototype.onanimate=function(){this.update(0);for(var e=0,r=this.dirtyComponents.length;e<r;e++)this.dirtyComponents[e].redraw();this.dirtyComponents=[],this.requestID=0},new o}(),c.inherits=function(o){var e=this,r=function(){e.apply(this,arguments),typeof o=="function"&&o.apply(this,arguments),this.constructor===r&&this.oninit()};return n(r,e),r.inherits=e.inherits,r};var p=function(){};p.prototype.update=function(o){},p.inherits=function(o){var e=this,r=function(){typeof o=="function"&&o.apply(this,arguments)};return n(r,e),r};var d=function(o){this._component=o,this._draggable=new i.Draggable(o.el)};d.prototype.enable=function(){this._draggable.enable({onstart:this.onstart.bind(this,this._component),onmove:this.onmove.bind(this,this._component),onend:this.onend.bind(this,this._component)})},d.prototype.disable=function(){this._draggable.disable()},d.prototype.onstart=function(o,e,r,a,s){},d.prototype.onmove=function(o,e,r,a,s){},d.prototype.onend=function(o,e,r,a,s){},d.inherits=function(o){var e=this,r=function(){e.apply(this,arguments),typeof o=="function"&&o.apply(this,arguments)};return n(r,e),r};var v={Component:c,Relation:p,Draggable:d};typeof t<"u"&&t.exports?t.exports=v:window.jCore=v})()}}),b=J();var M=class u extends b.Component{constructor(t){super(t),this.history=new A({size:100,key:"playbuild/input-history"}),this.oninit()}text(t){return h.value(this.el,t)}disabled(t){h.disabled(this.el,t)}isError(t){h.toggleClass(this.el,"error",t)}focus(){h.focus(this.el)}blur(){h.blur(this.el)}done(t){t?(this.isError(!0),h.once(this.el,"input",this.oninput.bind(this))):(this.history.push(this.text()),this.history.save(),this.text("")),this.disabled(!1),this.focus()}oninit(){this.history.load(),this.focus(),h.on(this.el,"keydown",this.onkeydown.bind(this))}onkeydown(t){let n=u.#t[t.which];n&&(this.isError(!1),this["on"+n](t))}onenter(){let t=this.text();t&&(this.disabled(!0),this.emit("exec",t,this.done.bind(this)))}onup(t){h.cancel(t),this.text(this.history.back())}ondown(t){h.cancel(t),this.text(this.history.forward())}oninput(){this.isError(!1)}static#t={13:"enter",38:"up",40:"down"}},A=class{constructor(t){this.data=[],this.index=0,this.size=t.size,this.key=t.key}current(){return this.data[this.index]||""}push(t){this.data.push(t),this.data.splice(0,this.data.length-this.size),this.index=this.data.length}back(){return this.index=Math.max(this.index-1,0),this.current()}forward(){return this.index=Math.min(this.index+1,this.data.length),this.current()}load(){this.data=h.load(this.key,[]),this.index=this.data.length}save(){h.save(this.key,this.data)}};var _=class u extends b.Component{constructor(t){super(),this.name=this.prop(t.name),this.moduleName=this.prop(t.moduleName),this.content=new N(h.find(this.el,".variable-content")),this.oninit()}nameElement(){return h.find(this.el,".variable-name")}moduleNameElement(){return h.find(this.el,".variable-module-name")}contentUrl(){return"playbuild_modules/"+encodeURI(this.moduleName())+".html"}circuitModule(){return this.content.circuitModule()}render(){return h.render(u.#t)}oninit(){h.text(this.nameElement(),this.name()),h.text(this.moduleNameElement(),this.moduleName())}load(){return this.content.load(this.contentUrl())}static#t=['<div class="variable">','<div class="variable-header">','<div class="variable-name"></div>','<div class="variable-module-name"></div>',"</div>",'<iframe class="variable-content"></iframe>',"</div>"].join("")},N=class extends b.Component{constructor(t){super(t)}contentWindow(){return h.contentWindow(this.el)}circuitModule(){let t=this.contentWindow().playbuild;return t&&t.exports}async load(t){if(!await new Promise((i,c)=>{let p=setTimeout(c,3e4,new Error("PlayBuildScript runtime error: Load timeout for content"));h.once(this.el,"load",()=>{clearTimeout(p),i(this.circuitModule())}),h.attr(this.el,{src:t})}))throw new Error("PlayBuildScript runtime error: Invalid circuit module");h.css(this.el,{height:h.contentHeight(this.el)+"px"})}};var L=class extends b.Component{constructor(t){super(t),this.variableTable={}}async loadVariable(t,n){let i=new _({name:t,moduleName:n});i.parentElement(this.el),i.redraw();try{return await i.load(),this.variableTable[t]=i,i}catch(c){throw i.parentElement(null),c}}deleteVariable(t){this.variableTable[t].parentElement(null),delete this.variableTable[t]}};var O=class{static parse(t){let n=Z(t),i=G(n);if(!$(i))throw new SyntaxError('PlayBuildScript parse error: Unexpected identifier "'+t+'"');return Q(i)}};function Z(u){let t=u.match(/".*?[^\\]"|'.*?[^\\]'|\.|#|:|>>|<<|[\w"'\/\\]+/g)||[],n=t.indexOf("#");return n!==-1?t.slice(0,n):t}function G(u){let t=u.slice();return t[0]===":"&&t.length>=2?(t.shift(),t[0]=t[0].toLowerCase()):t[1]===":"?(t.splice(1,1),t.unshift("new")):t[1]==="."&&t[3]===">>"&&t[5]==="."?(t.splice(3,1),t.unshift("bind")):t[1]==="."&&t[3]==="<<"&&(t.splice(3,1),t.unshift("send")),t}function $(u){switch(u[0]){case"new":return u.length===3&&/^[a-zA-Z]/.test(u[1])&&/^[a-zA-Z]/.test(u[2]);case"bind":case"unbind":return u.length===7&&u[2]==="."&&u[5]===".";case"send":return u.length>=4&&u.length<=5&&u[2]===".";case"delete":return u.length===2&&/^[a-zA-Z]/.test(u[1]);case"reset":return u.length===1;case"load":case"save":return u.length<=2;default:return u.length===0}}function Q(u){return u.filter(t=>t!==".").map(t=>{let n=t.charAt(0),i=t.slice(-1);return n===i&&(n==="'"||n==='"')&&(t=t.slice(1,-1)),t.replace(/\\(["'])/g,"$1")})}var C=class u{constructor(t){this.circuitModuleLoader=t.circuitModuleLoader,this.circuitModuleUnloader=t.circuitModuleUnloader,this.scriptLoader=t.scriptLoader,this.scriptSaver=t.scriptSaver,this.variableTable={},this.bindings=[]}findVariable(t){return g.find(g.values(this.variableTable),n=>n.circuitModule.get(t.name)===t)}findBinding(t,n){return g.find(this.bindings,i=>i.sourceMember===t&&i.targetMember===n)}fetchMember(t,n){if(!this.variableTable.hasOwnProperty(t))throw new Error('PlayBuildScript runtime error: variable "'+t+'" is not defined');let i=this.variableTable[t].circuitModule.get(n);if(!i)throw new Error('PlayBuildScript runtime error: member "'+t+"."+n+'" is not defined');return i}async loadVariable(t,n){let i=await this.circuitModuleLoader(t,n);if(!i)throw new Error("PlayBuildScript runtime error: Invalid circuit module");this.variableTable[t]=new Y({name:t,moduleName:n,circuitModule:i})}async unloadVariable(t){await this.circuitModuleUnloader(t),this.deleteVariable(t)}deleteVariable(t){let n=this.variableTable[t];this.bindings.filter(i=>this.findVariable(i.sourceMember)===n||this.findVariable(i.targetMember)===n).forEach(i=>{x.unbind(i.sourceMember,i.targetMember),g.remove(this.bindings,i)}),delete this.variableTable[t]}bind(t,n){if(this.findBinding(t,n))throw new Error("PlayBuildScript runtime error: Already bound");x.bind(t,n),this.bindings.push(new X({sourceMember:t,targetMember:n}))}unbind(t,n){let i=this.findBinding(t,n);if(!i)throw new Error("PlayBuildScript runtime error: Not bound");x.unbind(t,n),g.remove(this.bindings,i)}async loadScript(t,n){for(let[i,c]of t.split(/\r\n|\r|\n/g).entries())try{await this.exec(c)}catch(p){throw new SyntaxError(p.message,n,i+1)}}generateScript(){let t=g.values(this.variableTable).map(i=>i.name+":"+i.moduleName).join(`
`),n=this.bindings.map(i=>this.findVariable(i.sourceMember).name+"."+i.sourceMember.name+" >> "+this.findVariable(i.targetMember).name+"."+i.targetMember.name).join(`
`);return(t+`
`+n).trim()+`
`}async exec(t){typeof t=="string"&&(t=[t]);for(let n of t){let i=O.parse(n);if(i.length===0)return;let c=i.shift();await u.#t[c].apply(this,i)}}static#t={new(t,n){if(this.variableTable.hasOwnProperty(t))throw new Error('PlayBuildScript runtime error: variable "'+t+'" is already defined');return this.loadVariable(t,n)},bind(t,n,i,c){let p=this.fetchMember(t,n),d=this.fetchMember(i,c);this.bind(p,d)},unbind(t,n,i,c){let p=this.fetchMember(t,n),d=this.fetchMember(i,c);this.unbind(p,d)},send(t,n,i){this.fetchMember(t,n)(i)},delete(t){if(!this.variableTable.hasOwnProperty(t))throw new Error('PlayBuildScript runtime error: variable "'+t+'" is not defined');return this.unloadVariable(t)},reset(){return Promise.all(Object.keys(this.variableTable).map(t=>this.unloadVariable(t)))},async load(t){let n=await this.scriptLoader(t);return this.loadScript(n.text,n.fileName)},save(t){return this.scriptSaver(t,this.generateScript())}}},Y=class{constructor(t){this.name=t.name,this.moduleName=t.moduleName,this.circuitModule=t.circuitModule}},X=class{constructor(t){this.sourceMember=t.sourceMember,this.targetMember=t.targetMember}};var j=class extends b.Component{constructor(t){super(t)}async load(){let t=await new Promise(c=>{let p=d=>{c(h.file(h.target(d)))};h.on(this.el,"change",p),h.click(this.el),h.once(h.body(),"focus",()=>{h.off(this.el,"change",p)},!0)}),n=h.fileName(t);return h.value(this.el,""),{text:await h.readFile(t),fileName:n}}};var k=class extends b.Component{constructor(t){super(t),this.env=new C({circuitModuleLoader:this.circuitModuleLoader.bind(this),circuitModuleUnloader:this.circuitModuleUnloader.bind(this),scriptLoader:this.scriptLoader.bind(this),scriptSaver:this.scriptSaver.bind(this)}),this.commandInput=new M(h.find(this.el,".command-input")),this.fileInput=new j(h.find(this.el,".file-input")),this.content=new L(h.find(this.el,".content")),this.oninit()}async circuitModuleLoader(t,n){return(await this.content.loadVariable(t,n)).circuitModule()}async circuitModuleUnloader(t){this.content.deleteVariable(t)}async scriptLoader(t){if(!t)return this.commandInput.disabled(!1),this.commandInput.blur(),this.fileInput.load();let n=await h.ajax({type:"GET",url:"playbuild_scripts/"+t}),i=t.split("/").pop();return{text:n,fileName:i}}async scriptSaver(t,n){B.saveAs(new Blob([n],{type:"plain/text"}),t)}oninit(){this.commandInput.on("exec",this.onexec.bind(this))}async onexec(t,n){try{await this.env.exec(t),n()}catch(i){console.error(i),n(i)}}};h.export("PlayBuildModule",x.PlayBuildModule);var Yt=new k(h.body());})();
